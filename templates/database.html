{% extends "base.html" %}

{% block title %}Database - Diwali E-Pass System{% endblock %}

{% block styles %}
<style>
    .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .search-box {
        grid-column: 1 / -1;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    table {
        font-size: 14px;
    }
    
    table td {
        white-space: nowrap;
    }
    
    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .badge-single {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .badge-couple {
        background: #fce4ec;
        color: #c2185b;
    }
    
    .badge-cash {
        background: #e8f5e9;
        color: #388e3c;
    }
    
    .badge-online {
        background: #e1f5fe;
        color: #0277bd;
    }
    
    .badge-scanned {
        background: #c8e6c9;
        color: #2e7d32;
    }
    
    .badge-unscanned {
        background: #ffecb3;
        color: #f57f17;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }
    
    .page-btn {
        padding: 8px 16px;
        border: 1px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 500;
    }
    
    .page-btn:hover {
        background: #667eea;
        color: white;
    }
    
    .page-btn.active {
        background: #667eea;
        color: white;
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Pass Database</h1>
        <div class="user-info">
            <a href="{{ url_for('export_csv') }}" class="btn btn-success"> Export CSV</a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>
    </div>
    
    <div class="card">
        <form method="GET" id="filter-form">
            <div class="filters">
                <div class="search-box">
                    <input type="text" name="search" placeholder="üîç Search by name or phone..." 
                           value="{{ search }}" class="form-control" 
                           style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%;">
                </div>
                
                <div>
                    <select name="scanned" class="form-control" 
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%;">
                        <option value="">All Status</option>
                        <option value="scanned" {% if filter_scanned == 'scanned' %}selected{% endif %}>Scanned Only</option>
                        <option value="unscanned" {% if filter_scanned == 'unscanned' %}selected{% endif %}>Unscanned Only</option>
                    </select>
                </div>
                
                <div>
                    <select name="type" class="form-control" 
                            style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%;">
                        <option value="">All Types</option>
                        <option value="SINGLE" {% if filter_type == 'SINGLE' %}selected{% endif %}>Single</option>
                        <option value="COUPLE" {% if filter_type == 'COUPLE' %}selected{% endif %}>Couple</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">Apply Filters</button>
            </div>
        </form>
        
        <div style="margin-bottom: 15px; color: #666;">
            Showing {{ passes|length }} of {{ total_count }} passes
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 100px;">Action</th>
                        <th>Name(s)</th>
                        <th>Phone(s)</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Timing</th>
                        <th>Created</th>
                        <th>Status</th>
                        <th>Scanned By</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pass in passes %}
                    <tr>
                        <td>
                            <a href="{{ url_for('regenerate', pass_id=pass.pass_id) }}" 
                               class="btn btn-secondary" 
                               style="padding: 6px 10px; font-size: 12px; text-decoration: none; display: inline-block;"
                               title="Regenerate e-pass with same QR code">
                                üîÑ Regenerate
                            </a>
                        </td>
                        <td>
                            <strong>{{ pass.name1 }}</strong>
                            {% if pass.name2 %}
                            <br><small style="color: #666;">+ {{ pass.name2 }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {{ pass.phone1 }}
                            {% if pass.phone2 %}
                            <br><small style="color: #666;">{{ pass.phone2 }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge badge-{{ pass.pass_type|lower }}">{{ pass.pass_type }}</span>
                        </td>
                        <td>‚Çπ{{ pass.amount }}</td>
                        <td>
                            <span class="badge badge-{{ pass.payment_mode|lower }}">{{ pass.payment_mode }}</span>
                            {% if pass.txn_info %}
                            <br><small style="color: #666;">{{ pass.txn_info }}</small>
                            {% endif %}
                        </td>
                        <td><small>{{ pass.timing }}</small></td>
                        <td><small>{{ pass.created_at }}</small></td>
                        <td>
                            {% if pass.scanned_at %}
                            <span class="badge badge-scanned">‚úì Scanned</span>
                            <br><small style="color: #666;">{{ pass.scanned_at }}</small>
                            {% else %}
                            <span class="badge badge-unscanned">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pass.scanned_by %}
                            <small>{{ pass.scanned_by }}</small>
                            {% else %}
                            <small style="color: #999;">-</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #999;">
                            No passes found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}&search={{ search }}&scanned={{ filter_scanned }}&type={{ filter_type }}" 
               class="page-btn">‚Üê Previous</a>
            {% endif %}
            
            <span style="color: #666;">Page {{ page }} of {{ total_pages }}</span>
            
            {% if page < total_pages %}
            <a href="?page={{ page + 1 }}&search={{ search }}&scanned={{ filter_scanned }}&type={{ filter_type }}" 
               class="page-btn">Next ‚Üí</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-submit form on filter change
    document.querySelectorAll('select[name="scanned"], select[name="type"]').forEach(select => {
        select.addEventListener('change', () => {
            document.getElementById('filter-form').submit();
        });
    });
</script>
{% endblock %}
